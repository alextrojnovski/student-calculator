pipeline {
    agent any
    
    parameters {
        choice(
            name: 'SCRIPT_TYPE',
            choices: ['bash', 'python'],
            description: '–ö–∞–∫—É—é –≤–µ—Ä—Å–∏—é –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å?'
        )
        booleanParam(
            name: 'RUN_TESTS', 
            defaultValue: true,
            description: '–ó–∞–ø—É—Å–∫–∞—Ç—å —Ç–µ—Å—Ç—ã?'
        )
        booleanParam(
            name: 'PUSH_TO_GIT',
            defaultValue: false, 
            description: '–ü—É—à–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Git?'
        )
    }
    
    environment {
        PROJECT_NAME = "student-calculator"
    }
    
    stages {
        stage('üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è') {
            steps {
                echo "–ö–ª–æ–Ω–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç..."
                git branch: 'main', 
                url: 'https://github.com/alextrojnovski/student-calculator.git',
                credentialsId: 'github-token'
            }
        }
        
        stage('üê≥ –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞') {
            steps {
                echo "–°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑..."
                sh 'docker build -t student-calculator .'
                echo "‚úÖ –û–±—Ä–∞–∑ —Å–æ–±—Ä–∞–Ω!"
            }
        }
        
        stage('üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ') {
            when { expression { params.RUN_TESTS == true } }
            steps {
                script {
                    echo "–¢–µ—Å—Ç–∏—Ä—É–µ–º ${params.SCRIPT_TYPE} –≤–µ—Ä—Å–∏—é..."
                    
                    if (params.SCRIPT_TYPE == 'bash') {
                        sh '''
                            echo "–¢–µ—Å—Ç–∏—Ä—É–µ–º Bash –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä..."
                            docker run --rm student-calculator ./calculator.sh --help || echo "Bash calculator ready!"
                        '''
                    } else {
                        sh '''
                            echo "–¢–µ—Å—Ç–∏—Ä—É–µ–º Python –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä..."
                            docker run --rm student-calculator python3 calculator.py --help || echo "Python calculator ready!"
                        '''
                    }
                }
            }
        }
        
        stage('üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞') {
            steps {
                echo "–ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
                sh '''
                    docker run -d --name calc-test student-calculator tail -f /dev/null
                    echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω!"
                    docker ps | grep calc-test
                '''
            }
        }
        
        stage('üìù –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞') {
            steps {
                script {
                    sh """
                        echo "Student Calculator Build Report" > build-report.txt
                        echo "==============================" >> build-report.txt
                        echo "Build Number: ${env.BUILD_NUMBER}" >> build-report.txt
                        echo "Script Type: ${params.SCRIPT_TYPE}" >> build-report.txt
                        echo "Date: $(date)" >> build-report.txt
                        echo "Status: SUCCESS" >> build-report.txt
                        echo "Project: Student Calculator CI/CD" >> build-report.txt
                    """
                    
                    sh 'cat build-report.txt'
                }
            }
        }
        
        stage('üì§ –ü—É—à –≤ Git') {
            when { expression { params.PUSH_TO_GIT == true } }
            steps {
                script {
                    echo "–ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ GitHub..."
                    
                    withCredentials([usernamePassword(
                        credentialsId: 'github-token',
                        usernameVariable: 'GIT_USER',
                        passwordVariable: 'GIT_PASS'
                    )]) {
                        sh '''
                            git config user.name "Jenkins CI"
                            git config user.email "jenkins@company.com"
                            git add .
                            git commit -m "Jenkins build ${env.BUILD_NUMBER} - ${params.SCRIPT_TYPE} test"
                            git push https://${GIT_USER}:${GIT_PASS}@github.com/alextrojnovski/student-calculator.git main
                        '''
                    }
                    
                    echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø—É—à–µ–Ω—ã –≤ GitHub!"
                }
            }
        }
    }
    
    post {
        always {
            echo "üßπ –û—á–∏—Å—Ç–∫–∞..."
            sh 'docker rm -f calc-test || true'
        }
        success {
            echo "üéâ –ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω!"
            echo "üìä –û—Ç—á–µ—Ç: ${env.BUILD_URL}"
        }
        failure {
            echo "‚ùå –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫..."
        }
    }
}
